name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: deploy-${{ github.run_id }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: github-pages          # Pages ç”¨ã®ç’°å¢ƒå

    steps:
      # 1. ã‚½ãƒ¼ã‚¹å–å¾—
      - name: âœ… Checkout
        uses: actions/checkout@v4

      # 2. Node.js æº–å‚™
      - name: ğŸ§° Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # 3. ä¾å­˜ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: ğŸ“¦ Install dependencies
        run: npm ci
        working-directory: pro

      # 4. Firebase ç’°å¢ƒå¤‰æ•°ã‚’æ›¸ãè¾¼ã‚€
      - name: ğŸ” Inject Firebase environment variables
        run: |
          echo "REACT_APP_FIREBASE_API_KEY=${{ secrets.REACT_APP_FIREBASE_API_KEY }}"       >> pro/.env
          echo "REACT_APP_FIREBASE_AUTH_DOMAIN=${{ secrets.REACT_APP_FIREBASE_AUTH_DOMAIN }}" >> pro/.env
          echo "REACT_APP_FIREBASE_PROJECT_ID=${{ secrets.REACT_APP_FIREBASE_PROJECT_ID }}"   >> pro/.env
          echo "REACT_APP_FIREBASE_STORAGE_BUCKET=${{ secrets.REACT_APP_FIREBASE_STORAGE_BUCKET }}" >> pro/.env
          echo "REACT_APP_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.REACT_APP_FIREBASE_MESSAGING_SENDER_ID }}" >> pro/.env
          echo "REACT_APP_FIREBASE_APP_ID=${{ secrets.REACT_APP_FIREBASE_APP_ID }}"           >> pro/.env

      # 5. ãƒ“ãƒ«ãƒ‰
      - name: ğŸ› ï¸ Build the project
        run: npm run build
        working-directory: pro

      # 6. ãƒ“ãƒ«ãƒ‰å†…å®¹ã‚’ç¢ºèªï¼ˆä»»æ„ãƒ»ãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
      - name: ğŸ§ª Show build contents (debug)
        run: |
          echo "Working dir: $(pwd)"
          echo "--- pro/build/ ---"
          ls -la pro/build || echo "âŒ build/ not found"
          echo "--- index.html ---"
          cat pro/build/index.html | head -n 20 || echo "âŒ index.html not found"

      # 7. GitHub Pages ç”¨ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: ğŸ“¤ Upload Pages artifact
        uses: actions/upload-pages-artifact@v3   # â† å°‚ç”¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        with:
          path: pro/build                        # React ã® build å‡ºåŠ›

      # 8. ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: ğŸš€ Deploy to GitHub Pages
        uses: actions/deploy-pages@v4            # â† v4 ã«æ›´æ–°
